# 経費申請OCRトラブルシューティングガイド

## OCR機能が動作しない場合の診断手順

### 1. 環境変数の確認

OCR機能を使用するには、以下の環境変数が正しく設定されている必要があります:

#### Viteプロジェクトの場合（このプロジェクト）:
```bash
# .env.local ファイルに以下を追加
VITE_API_KEY=your_gemini_api_key_here
# または
VITE_GEMINI_API_KEY=your_gemini_api_key_here
# 任意でOCR専用モデルを指定
VITE_GEMINI_OCR_MODEL=gemini-2.0-flash

# AI機能を無効化する場合（デバッグ用）
VITE_AI_OFF=0  # 0=有効, 1=無効
```

#### 従来の環境変数名（後方互換性のため対応）:
```bash
API_KEY=your_gemini_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here
NEXT_PUBLIC_AI_OFF=0
```

**重要**: Viteプロジェクトでは環境変数に `VITE_` プレフィックスが必要です。
環境変数を変更した後は、開発サーバーを再起動してください。

### 1-2. Gemini APIキーの取得方法

1. [Google AI Studio](https://aistudio.google.com/app/apikey) にアクセス
2. 「Get API Key」をクリック
3. 新しいAPIキーを作成
4. 作成されたキーを `.env.local` ファイルに設定

### 1-3. Supabaseストレージの設定

Supabaseを使用している場合、`inbox` バケットを作成する必要があります:

1. Supabaseダッシュボードで「Storage」を開く
2. 「New bucket」をクリック
3. バケット名: `inbox`
4. Public bucket: チェックを入れる（または適切なポリシーを設定）
5. 「Create bucket」をクリック

### 2. ブラウザのコンソールログを確認

開発者ツール（F12）を開き、コンソールタブで以下のログを確認してください:

#### 正常な場合のログ:
```
[OCR] ファイルアップロード開始: receipt.jpg タイプ: image/jpeg サイズ: 123456
[OCR] ファイルをストレージにアップロード中...
[OCR] ストレージアップロード完了: inbox/xxxxx.jpg
[OCR] DBアイテム作成完了: uuid-xxxx-xxxx
[OCR] ファイルをBase64に変換中...
[OCR] Base64変換完了。文字列長: 123456
[OCR] AI-OCR解析開始...
[Gemini] OCR解析開始 - mimeType: image/jpeg base64長: 123456
[Gemini] 勘定科目数: 10 振分区分数: 5
[Gemini] Gemini APIを呼び出し中...
[Gemini] API応答受信: {"vendorName":"...
[Gemini] JSON解析成功: {...}
[OCR] AI-OCR解析完了: {...}
```

#### エラーが発生する場合:
- **AI機能が無効**: `[OCR] AI機能が無効です。自動解析をスキップします。`
  - 対処: `NEXT_PUBLIC_AI_OFF=0` に設定するか、環境変数を削除
  
- **APIキー未設定**: `AI APIキーが設定されていません。`
  - 対処: `.env.local` に `API_KEY` または `GEMINI_API_KEY` を設定
  
- **ネットワークエラー**: `オフラインです。ネットワーク接続を確認してください。`
  - 対処: インターネット接続を確認
  
- **ファイル読み取りエラー**: `ファイル読み取りに失敗しました。`
  - 対処: ファイル形式を確認（JPEG, PNG, PDF対応）

### 3. 対応ファイル形式

OCR機能は以下のファイル形式に対応しています:
- 画像: JPEG, PNG, WebP
- 文書: PDF

### 4. 経費申請フォームでのOCR使用方法

1. 経費申請フォームを開く
2. 「領収書を読み取る」ボタンをクリック
3. 領収書の画像ファイルを選択
4. AI解析が完了すると、自動的に明細行が追加されます
5. 必要に応じて内容を修正してください

### 5. インボックスでのOCR使用方法

1. 「インボックス (AI-OCR)」タブを開く
2. ファイルをドラッグ&ドロップまたはクリックしてアップロード
3. AI解析が完了すると「要確認」ステータスになります
4. 内容を確認し、「承認」ボタンをクリックして経費申請に追加

### 6. よくある問題と解決方法

#### 問題: OCRボタンが表示されない
- **原因**: AI機能が無効化されている
- **解決**: 環境変数 `NEXT_PUBLIC_AI_OFF` を確認

#### 問題: 解析が遅い
- **原因**: ファイルサイズが大きい、またはネットワークが遅い
- **解決**: 画像を圧縮するか、ネットワーク環境を改善

#### 問題: 解析結果が不正確
- **原因**: 画像の品質が低い、または領収書の形式が特殊
- **解決**: 
  - より高解像度の画像を使用
  - 画像を明るく、鮮明に撮影
  - 解析後に手動で修正

#### 問題: 勘定科目や振分区分が自動選択されない
- **原因**: AIが提案した名称とマスタデータが一致しない
- **解決**: 
  - マスタデータに該当する項目を追加
  - 解析後に手動で選択

### 7. デバッグモード

詳細なログを確認するには、ブラウザのコンソールを開いた状態でOCR機能を使用してください。
すべての処理ステップがログに記録されます。

### 8. サポート

問題が解決しない場合は、以下の情報を添えてサポートに連絡してください:
- ブラウザのコンソールログ（エラーメッセージ全文）
- 使用したファイルの形式とサイズ
- 環境変数の設定状況（APIキーは除く）
