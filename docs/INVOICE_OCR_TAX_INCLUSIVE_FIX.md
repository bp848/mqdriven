# 請求書OCR 税込/税抜対応 実装完了

## 概要
経費精算の請求書OCRで、税込請求書と税抜請求書を正しく区別して処理できるようになりました。

## 問題点
以前は、OCRで読み取った請求書の金額が税込の場合でも、さらに消費税が加算されてしまい、二重課税となる問題がありました。

## 実装内容

### 1. AI OCR解析の改善 (`services/geminiService.ts`)
- **税込/税抜の自動判定**: AIが請求書から税込/税抜を自動判定
  - 請求書に「税込」「内税」などの表記があれば`taxInclusive: true`
  - 「税抜」「外税」などの表記があれば`taxInclusive: false`
  - 表記がない場合は金額の関係から判定（合計 = 税抜 + 税額）
- **スキーマの更新**: `extractInvoiceSchema`に`taxInclusive`フィールドを追加
- **フォールバック計算**: 税込/税抜が不明な場合のデフォルト値設定

### 2. 経費計上ロジックの修正 (`components/accounting/Accounting.tsx`)
税込/税抜を正確に処理する仕訳計上ロジックに変更：

#### 税込請求書の場合:
```
借方: 仕入高（または指定勘定）  税抜金額
借方: 仮払消費税               消費税額
貸方: 買掛金                   税込合計
```

#### 税抜請求書の場合:
```
借方: 仕入高（または指定勘定）  税抜金額
借方: 仮払消費税               消費税額（10%）
貸方: 買掛金                   税込合計
```

### 3. UI改善 (`InvoiceOCR.tsx`, `components/InvoiceOCR.tsx`)
- **税込チェックボックスの追加**: ユーザーが税込/税抜を選択・変更可能
- **ヘルプテキスト**: 「※請求書が税込表示の場合はチェック、税抜表示の場合はチェックを外してください」を表示
- **視覚的配置**: 合計金額フィールドの隣に配置し、関連性を明確化

## 使用方法

1. **請求書アップロード**: 請求書をアップロードすると、AIが自動で税込/税抜を判定
2. **確認と修正**: 自動判定が正しいか確認し、必要に応じてチェックボックスで修正
3. **承認**: 内容が正しければ「承認して計上」をクリック
4. **仕訳計上**: 税込/税抜に応じて正確に仕訳が作成される

## メリット

✅ **二重課税の防止**: 税込請求書でも正確に税額を分離  
✅ **自動判定**: AIが税込/税抜を自動判定し、手入力の手間を削減  
✅ **手動調整可能**: AIの判定が不正確な場合も、ユーザーが簡単に修正可能  
✅ **会計処理の正確性**: 仮払消費税を正しく計上し、消費税申告に対応  

## テスト確認事項

- [x] AIが税込請求書を正しく判定
- [x] AIが税抜請求書を正しく判定
- [x] 税込チェックボックスが正しく動作
- [x] 税込請求書の仕訳が正しく計上（税抜金額+仮払消費税）
- [x] 税抜請求書の仕訳が正しく計上
- [x] ビルドが成功

## 今後の改善案

1. **税率変更対応**: 将来的に税率が変更された場合の対応
2. **複数税率対応**: 軽減税率（8%）と標準税率（10%）の混在
3. **税額端数処理**: 税込から税抜を逆算する際の端数処理方法の選択

---

実装日: 2026-02-17  
対応者: AI Assistant
